<!DOCTYPE html>
<html>
  <head>
    <script src="http://localhost:8000/pyodide.js"></script>
  </head>

  <body>
    <p id="title">My first Pyodide app</p>
    <div id="simplification"></div>

    <script>
      function display_steps(pyodide, contentDivName = 'simplification'){

        const contentDiv = document.getElementById(contentDivName);

        // Known file paths
        console.log("set file paths")
        const jsonFile = 'Solutions/circuit_step1.json';
        const svgFile = 'Solutions/circuit_step1.svg';

        try {
          // Fetch JSON data
          console.log("fetch json file")
          let jsonDataString = pyodide.FS.readFile(jsonFile, { encoding: "utf8" });
          const jsonData = JSON.parse(jsonDataString);

          // Fetch SVG data
          console.log("fetch svg file")
          const svgData = pyodide.FS.readFile(svgFile, { encoding: "utf8" });

          // Create a paragraph element to hold the JSON data
          console.log("create paragraph")
          const paragraph = document.createElement('p');
          paragraph.innerHTML = `Die Elemente ${jsonData.name1} und ${jsonData.name2}<br>
           wurden zu ${jsonData.newName} zusammengefasst\r\n<br>
           Wert Element 1 = ${jsonData.value1}${jsonData.unit}\r\n<br>
           Wert Element 2 = ${jsonData.value2}${jsonData.unit}\r\n<br>
           Ergebnis = ${jsonData.result}${jsonData.unit}\r\n<br>
           Die Elemente sind in ${jsonData.relation}`;

          console.log("create div")
          // Create a div element to hold the SVG data
          const svgDiv = document.createElement('div');
          svgDiv.innerHTML = svgData;

          console.log("append content")
          // Append the paragraph and SVG div to the content div
          contentDiv.appendChild(paragraph);
          contentDiv.appendChild(svgDiv);
        } catch (error) {
          console.error('Error fetching data:', error);
          contentDiv.textContent = 'Error loading content';
        }
      }

      async function main() {
        

        let packageAdress = "http://localhost:8000/Packages/"
        let pyodide = await loadPyodide();
        await pyodide.loadPackage(packageAdress + "packaging-23.1-py3-none-any.whl");

        //sympy
        await pyodide.loadPackage(packageAdress + "mpmath-1.3.0-py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "sympy-1.12-py3-none-any.whl");

        //standalone packages
        await pyodide.loadPackage(packageAdress + "wheel-0.43.0-py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "setuptools-68.1.2-py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "property_cached-1.6.4-py2.py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "numpy-1.26.4-cp311-cp311-emscripten_3_1_46_wasm32.whl");
        await pyodide.loadPackage(packageAdress + "networkx-3.1-py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "ordered_set-4.1.0-py3-none-any.whl")

        //date_util
        await pyodide.loadPackage(packageAdress + "six-1.16.0-py2.py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "python_dateutil-2.8.2-py2.py3-none-any.whl");

        //standalone packages for matplotlib and matplotlib
        await pyodide.loadPackage(packageAdress + "pyparsing-3.1.1-py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "Pillow-10.0.0-cp311-cp311-emscripten_3_1_46_wasm32.whl")
        await pyodide.loadPackage(packageAdress + "pytz-2023.3-py2.py3-none-any.whl")
        await pyodide.loadPackage(packageAdress + "kiwisolver-1.4.4-cp311-cp311-emscripten_3_1_46_wasm32.whl")
        await pyodide.loadPackage(packageAdress + "importlib_resources-6.4.0-py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "fonttools-4.42.1-py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "cycler-0.11.0-py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "contourpy-1.2.0-cp311-cp311-emscripten_3_1_46_wasm32.whl");
        await pyodide.loadPackage(packageAdress + "matplotlib-3.5.2-cp311-cp311-emscripten_3_1_46_wasm32.whl");
        await pyodide.loadPackage(packageAdress + "matplotlib_pyodide-0.2.0-py3-none-any.whl")
        await pyodide.loadPackage(packageAdress + "schemdraw-0.19-py3-none-any.whl")

        //ipython
        await pyodide.loadPackage(packageAdress + "typing_extensions-4.7.1-py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "traitlets-5.14.2-py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "asttokens-2.4.1-py2.py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "executing-2.0.1-py2.py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "pure_eval-0.2.2-py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "stack_data-0.6.3-py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "wcwidth-0.2.13-py2.py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "prompt_toolkit-3.0.43-py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "Pygments-2.16.1-py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "matplotlib_inline-0.1.6-py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "pickleshare-0.7.5-py2.py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "parso-0.8.3-py2.py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "jedi-0.19.0-py2.py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "decorator-5.1.1-py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "colorama-0.4.6-py2.py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "backcall-0.2.0-py2.py3-none-any.whl");
        await pyodide.loadPackage(packageAdress + "ipython-8.23.0-py3-none-any.whl");

        //lcapy
        await pyodide.loadPackage(packageAdress + "lcapy-1.22+inskale.0.1-py3-none-any.whl");

        await pyodide.runPythonAsync(`
          from pyodide.http import pyfetch
          response = await pyfetch("http://localhost:8000/solve.py")
          with open("solve.py", "wb") as f:
              f.write(await response.bytes())

          response = await pyfetch("http://localhost:8000/Circuits.zip") # .zip, .whl, ...
          await response.unpack_archive() # by default, unpacks to the current dir
          print("loaded and unpacked")
        `);
        pyodide.pyimport("solve");
        let files = pyodide.FS.readdir("Solutions")

        //remove '.' and '..' from file list
        while (files[0] === "." || files[0] === ".."){
          files.splice(0, 1)
        }
        console.log(files)

        display_steps(pyodide)


      }
      main();
    </script>
  </body>
</html>