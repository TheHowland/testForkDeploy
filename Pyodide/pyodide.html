<!DOCTYPE html>
<html>
  <head>
    <script src="http://localhost:8000/pyodide.js"></script>
    <style>
      #progress-container {
        width: 100%;
        max-width: 200px;
        background-color: #f3f3f3;
      }
      #progress-bar {
        width: 0;
        max-width: 200px;
        height: 20px;
        background-color: #4caf50;
        text-align: center;
        line-height: 20px;
        color: white;
      }
    </style>
  </head>

  <body>
    <div id="simplification"></div>

    <script>
      async function fetchDirectoryListing(url, extension = "") {
        try {
          // Fetch the directory listing HTML
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          const htmlText = await response.text();

          // Parse the HTML
          const parser = new DOMParser();
          const doc = parser.parseFromString(htmlText, 'text/html');

          // Extract file names from the parsed HTML
          const fileLinks = doc.querySelectorAll('a'); // Assuming files are listed as <a> tags
          const fileNames = [];
          fileLinks.forEach(link => {
            const fileName = link.getAttribute('href');
            if (fileName && !fileName.endsWith('/')) { // Filter out directories if needed
              if(extension === "" || (extension !== "" && fileName.endsWith(extension))) {
                fileNames.push(fileName);
              }
            }
          });

          return fileNames;
        }
        catch (error) {
          console.error('Error fetching directory listing:', error);
          return [];
        }
      }

      function display_steps(pyodide, jsonFilePath, svgFilePath, contentDivName = 'simplification'){

        const contentDiv = document.getElementById(contentDivName);

        try {
          // Fetch JSON data
          let jsonDataString = pyodide.FS.readFile(jsonFilePath, { encoding: "utf8" });
          console.log("Solution from Json:" + jsonDataString)
          const jsonData = JSON.parse(jsonDataString);

          // Fetch SVG data
          const svgData = pyodide.FS.readFile(svgFilePath, { encoding: "utf8" });

          // Create a paragraph element to hold the JSON data
          const paragraph = document.createElement('p');
          paragraph.innerHTML = `Die Elemente ${jsonData.name1} und ${jsonData.name2}<br>
           wurden zu ${jsonData.newName} zusammengefasst<br>
           Wert Element 1 = ${jsonData.value1}${jsonData.unit}<br>
           Wert Element 2 = ${jsonData.value2}${jsonData.unit}<br>
           Ergebnis = ${jsonData.result}${jsonData.unit}<br>
           Die Elemente sind in ${jsonData.relation}`;

          // Create a div element to hold the SVG data
          const svgDiv = document.createElement('div');
          console.log("svg-Data:" + svgData)
          svgDiv.innerHTML = svgData;

          // Append the paragraph and SVG div to the content div
          contentDiv.appendChild(paragraph);
          contentDiv.appendChild(svgDiv);
          console.log("log svg elements");
          svgDiv.querySelectorAll('*').forEach(element => {
            console.log(element.outerHTML);
          });

          svgDiv.querySelectorAll('path').forEach(pathElement => {
            pathElement.style.pointerEvents = 'bounding-box';
            pathElement.style.cursor = 'pointer';

            pathElement.addEventListener('click', () => {
              const elementId = pathElement.getAttribute('id');
              if (elementId) {
                alert(`Clicked on path element with id: ${elementId}`);
              } else {
                alert('Clicked on a path element without an id');
              }
            });
          });
        } catch (error) {
          console.error('Error fetching data:', error);
          contentDiv.textContent = 'Error loading content';
        }
      }

      function createProgressBar(infoText) {
        const container = document.createElement('div');
        container.id = 'progress-container';

        const bar = document.createElement('div');
        bar.id = 'progress-bar';
        bar.textContent = '0%';

        container.appendChild(bar);
        document.body.appendChild(container);

        // Show the progress bar
        container.style.display = 'block';
      }

      function updateProgressBar(percentage) {
        const progressBar = document.getElementById('progress-bar');
        progressBar.style.width = percentage + '%';
        progressBar.textContent = percentage + '%';
      }

      function removeProgressBar() {
        const container = document.getElementById('progress-container');
        if (container) {
          container.remove();
        }
      }

      async function load_packages(pyodide){
        createProgressBar("Loading Pyodide packages, please wait ...");
        updateProgressBar(0)
        let packageAddress = "http://localhost:8000/Packages/";

        let packages = await fetchDirectoryListing(packageAddress, ".whl")
        let i = 0;
        for(const pyPackage of packages) {
          console.log("Insalling:" + pyPackage)
          let pkgArrBuff = await (await fetch("http://localhost:8000/Packages/" + pyPackage)).arrayBuffer();
          pyodide.unpackArchive(pkgArrBuff, "whl")
          updateProgressBar(Math.floor((i / packages.length) * 100))
          i++;
        }
        removeProgressBar()
      }

      async function main() {
        const infoText = document.createElement('div')
        infoText.textContent = ""
        document.body.appendChild(infoText)
        infoText.setAttribute('style', 'white-space: pre;')

        infoText.textContent = "Loading Pyodide environment... "
        let pyodide = await loadPyodide();
        infoText.textContent += "done\r\n"

        infoText.textContent += "Loading necessary python packages, this may take a while... "
        console.log("Installing: sqlite3")
        let pkgArrBuff = await (await fetch("http://localhost:8000/sqlite3-1.0.0.zip")).arrayBuffer();
        await pyodide.unpackArchive(pkgArrBuff, "zip")

        await load_packages(pyodide)
        infoText.textContent += "done\r\n"

        infoText.textContent += "calculating solution ..."
        await pyodide.runPythonAsync(`
          from pyodide.http import pyfetch
          response = await pyfetch("http://localhost:8000/solve.py")
          with open("solve.py", "wb") as f:
              f.write(await response.bytes())

          response = await pyfetch("http://localhost:8000/Circuits.zip") # .zip, .whl, ...
          await response.unpack_archive() # by default, unpacks to the current dir
          print("loaded and unpacked")
        `);
        let solve = pyodide.pyimport("solve");
        solve.solve_circuit("Circuit_resistors.txt")


        let files = await pyodide.FS.readdir("Solutions")

        //remove '.' and '..' from file list
        while (files[0] === "." || files[0] === ".."){
          files.splice(0, 1);
        }

        let jsonFiles = [];
        let svgFiles = [];
        files.forEach((file) => {
          if(file.search(".+\.json") >= 0){
            jsonFiles.push(file);
          }
          if(file.search(".+\.svg") >= 0){
            svgFiles.push(file);
          }
        })

        for(let i = 0; i < jsonFiles.length; i++){
          if(jsonFiles[i].replace(".json","") !== svgFiles[i].replace(".svg","")){
            pyodide.FS.rmdir("Solutions")
            throw new Error("Files did not match, Solutions cleared please try again")
          }
          display_steps(pyodide, "Solutions/"+jsonFiles[i], "Solutions/"+svgFiles[i])
        }
        infoText.textContent += "done\r\n"
        document.body.removeChild(infoText)
      }
      main();
    </script>
  </body>
</html>