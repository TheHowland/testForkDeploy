<!DOCTYPE html>
<html>
<head>
    <script src="http://localhost:8000/pyodide.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <title>Circuit Simplification</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(to right, #ece9e6, #ffffff);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
        }
        #simplification {
            width: 90vw;
            max-width: 1200px;
            background: #fff;
            padding: 2vw;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: width 0.3s;
        }
        .content-container {
            display: flex;
            width: 100%;
            justify-content: space-between;
            align-items: center;
            gap: 2vw;
        }
        .circuit-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex: 1;
            margin-bottom: 2vh;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 2vw;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background: #fff;
            height: 60vh;
            overflow: hidden;
        }
        .svg-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        svg {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .description-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60vh;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 2vw;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background: #fff;
        }
        .bounding-box {
            fill: red;
            stroke: black;
            stroke-width: 1;
            fill-opacity: .1;
            pointer-events: none;
        }
        #progress-container {
            width: 80%;
            max-width: 300px;
            background-color: #f3f3f3;
            border-radius: 25px;
            overflow: hidden;
            margin: 2vh auto;
        }
        #progress-bar {
            width: 0;
            height: 2vh;
            background-color: #4caf50;
            text-align: center;
            line-height: 2vh;
            color: white;
            transition: width 0.3s;
        }
        .clicked-elements-container {
            border: 1px solid #ddd;
            padding: 1vh;
            margin-top: 2vh;
            display: inline-block;
            vertical-align: top;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 80%;
        }
        .reset-button,
        .check-button {
            margin-top: 1vh;
            padding: 1vh 2vw;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 2vh;
            transition: background 0.3s, transform 0.2s;
        }
        .reset-button {
            background-color: #f44336;
            color: white;
        }
        .check-button {
            background-color: #4caf50;
            color: white;
        }
        .reset-button:hover,
        .check-button:hover {
            transform: scale(1.05);
        }
        #message-box {
            display: none;
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: #333;
            color: #fff;
            border-radius: 5px;
            z-index: 1000;
        }
        #menu-bar {
            position: fixed;
            top: 0;
            left: -250px;
            width: 250px;
            height: 100%;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            padding: 20px;
            box-sizing: border-box;
            transition: left 0.3s;
            z-index: 1000;
        }
        #menu-toggle {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 30px;
            height: 30px;
            background-color: #333;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        #menu-toggle::before {
            content: "\2630"; /* Unicode for hamburger icon */
        }
        .nav-buttons-container {
            display: flex;
            justify-content: center;
            gap: 2vw;
            margin-top: 10px;
        }
        .nav-button {
            margin-top: 1vh;
            padding: 1vh 2vw;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 2vh;
            transition: background 0.3s, transform 0.2s;
            background-color: #2196f3;
            color: white;
        }
        .nav-button:hover {
            transform: scale(1.05);
        }
    </style>
</head>

<body>
<div id="simplification"></div>
<div id="menu-bar">
    <select id="mode">
        <option value="" disabled selected>Select Mode</option>
        <option value="user">User Based Mode</option>
        <option value="pre_calculated">Pre Calculated Mode</option>
    </select>
    <label for="circuit-selector">Select Circuit:</label>
    <select id="circuit-selector">
        <option value="" disabled selected>Select Circuit</option>
    </select>
</div>
<button id="menu-toggle"></button>
<div id="message-box"></div>
<div class="nav-buttons-container" style="display: none;">
    <button id="prev-button" class="nav-button">Previous</button>
    <button id="next-button" class="nav-button">Next</button>
</div>
<div id="initial-message" style="display: none;">Please select a mode and circuit</div>
<script>
    let currentStep = 0;
    let jsonFiles = [];
    let svgFiles = [];
    let circuitFiles = [];
    let selectedElements = [];
    let currentCircuit = "";
    let stepSolve; // Declare globally to access across functions
    let mode = '';

    class SolutionObject {
        constructor(name1, name2, newName, value1, value2, result, relation, latexEquation) {
            this._name1 = name1;
            this._name2 = name2;
            this._newName = newName;
            this._value1 = value1;
            this._value2 = value2;
            this._result = result;
            this._relation = relation;
            this._latexEquation = latexEquation;

            this._inlineReturnFunc = (string) => `\\(${string}\\)`;
            this._blockReturnFunc = (string) => `$$${string}$$`;

            this._returnFunction = this._inlineReturnFunc;
        }

        set returnFunction(func) {
            this._returnFunction = func;
        }

        inline() {
            this._returnFunction = this._inlineReturnFunc;
            return this;
        }

        block() {
            this._returnFunction = this._blockReturnFunc;
            return this;
        }

        noFormat() {
            this._returnFunction = (string) => string;
            return this;
        }

        _format(string) {
            return this._returnFunction(string);
        }

        isNull() {
            return (!this._name1) && (!this._name2) && (!this._newName) &&
                (!this._value1) && (!this._value2) && (!this._result) &&
                (!this._relation) && (!this._latexEquation);
        }

        get name1() {
            return this._format(this._name1);
        }

        get name2() {
            return this._format(this._name2);
        }

        get newName() {
            return this._format(this._newName);
        }

        get value1() {
            return this._format(this._value1);
        }

        get value2() {
            return this._format(this._value2);
        }

        get result() {
            return this._format(this._result);
        }

        get relation() {
            return this._format(this._relation);
        }

        get latexEquation() {
            return this._format(this._latexEquation);
        }

    }

    function sanitizeSelector(selector) {
        return selector.replace(/[^\w-]/g, '_');
    }

    function populateCircuitSelector() {
        const circuitSelector = document.getElementById('circuit-selector');
        circuitSelector.innerHTML = '<option value="" disabled selected>Select Circuit</option>';

        circuitFiles.forEach(file => {
            const option = document.createElement('option');
            option.value = file;
            option.text = file.replace('.txt', '');
            circuitSelector.appendChild(option);
        });
    }

    async function fetchDirectoryListing(url, extension = "") {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const htmlText = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            const fileLinks = doc.querySelectorAll('a');
            const fileNames = [];
            fileLinks.forEach(link => {
                const fileName = link.getAttribute('href');
                if (fileName && !fileName.endsWith('/')) {
                    if (extension === "" || (extension !== "" && fileName.endsWith(extension))) {
                        fileNames.push(fileName);
                    }
                }
            });
            return fileNames;
        } catch (error) {
            console.error('Error fetching directory listing:', error);
            return [];
        }
    }

    function display_step(pyodide, jsonFilePath, svgFilePath, contentDivName = 'simplification') {
        const contentDiv = document.getElementById(contentDivName);
        contentDiv.innerHTML = '';

        try {
            let jsonDataString = pyodide.FS.readFile(jsonFilePath, { encoding: "utf8" });
            const jsonData = JSON.parse(jsonDataString);
            let data = new SolutionObject(jsonData.name1, jsonData.name2, jsonData.newName, jsonData.value1, jsonData.value2,
                jsonData.result, jsonData.relation, jsonData.latexEquation);

            const svgData = pyodide.FS.readFile(svgFilePath, { encoding: "utf8" });

            let relationText = "";
            if (!data.isNull()) {
                if (data.noFormat().relation === "parallel") {
                    relationText = "Die Elemente sind parallel zueinander";
                } else if (data.noFormat().relation === "series") {
                    relationText = "Die Elemente sind in Reihe zueinander";
                } else if (data.noFormat().relation === null) {
                    relationText = "Keine Beziehung zwischen den Elementen";
                } else {
                    throw Error("Unknown relation type");
                }
            }

            const circuitContainer = document.createElement('div');
            circuitContainer.className = 'circuit-container';

            const svgDiv = document.createElement('div');
            svgDiv.className = 'svg-container';
            svgDiv.innerHTML = svgData;

            const sanitizedSvgFilePath = sanitizeSelector(svgFilePath);

            circuitContainer.appendChild(svgDiv);

            const descriptionContainer = document.createElement('div');
            descriptionContainer.className = 'description-container';

            const paragraph = document.createElement('p');
            paragraph.innerHTML = `Die Elemente ${data.inline().name1} und ${data.inline().name2}<br>
          wurden zu ${data.inline().newName} zusammengefasst<br>
          ${data.inline().name1}&nbsp= ${data.inline().value1}<br>
          ${data.inline().name2}&nbsp= ${data.inline().value2}<br>
          ${data.inline().newName}&nbsp= ${data.inline().result}<br>
          ${relationText}<br>
          Rechnung:<br>
          ${data.inline().latexEquation}`;

            descriptionContainer.appendChild(paragraph);

            const contentContainer = document.createElement('div');
            contentContainer.className = 'content-container';
            contentContainer.appendChild(circuitContainer);
            contentContainer.appendChild(descriptionContainer);
            contentDiv.appendChild(contentContainer);

            if (mode === 'user') {
                const clickedElementsContainer = document.createElement('div');
                clickedElementsContainer.className = 'clicked-elements-container';
                clickedElementsContainer.innerHTML = `<h3>Clicked Elements</h3><ul id="clicked-elements-list-${sanitizedSvgFilePath}"></ul>`;

                const resetButton = document.createElement('button');
                resetButton.className = 'reset-button';
                resetButton.textContent = 'Reset';
                resetButton.addEventListener('click', () => {
                    resetClickedElements(svgDiv, clickedElementsContainer);
                });

                const checkButton = document.createElement('button');
                checkButton.className = 'check-button';
                checkButton.textContent = 'Check';
                checkButton.addEventListener('click', async () => {
                    if (selectedElements.length === 2) {
                        const canSimplify = await stepSolve.simplifyTwoCpts(selectedElements).toJs();
                        if (canSimplify[0]) {
                            display_step(pyodide, canSimplify[1], canSimplify[2]);
                            resetClickedElements(svgDiv, clickedElementsContainer);
                        } else {
                            showMessage("The selected elements cannot be simplified.");
                        }
                    } else {
                        showMessage("Please select exactly two elements.");
                    }
                    MathJax.typeset();
                });

                clickedElementsContainer.appendChild(resetButton);
                clickedElementsContainer.appendChild(checkButton);
                descriptionContainer.appendChild(clickedElementsContainer);

                const clickedElementsList = clickedElementsContainer.querySelector(`#clicked-elements-list-${sanitizedSvgFilePath}`);

                svgDiv.querySelectorAll('path').forEach(pathElement => {
                    pathElement.style.pointerEvents = 'bounding-box';
                    pathElement.style.cursor = 'pointer';

                    pathElement.addEventListener('click', () => {
                        const bboxId = `bbox-${pathElement.getAttribute('id') || Math.random().toString(36).substr(2, 9)}`;
                        const existingBox = document.getElementById(bboxId);
                        if (existingBox) {
                            existingBox.remove();
                            const listItem = document.querySelector(`li[data-bbox-id="${bboxId}"]`);
                            if (listItem) {
                                listItem.remove();
                                selectedElements = selectedElements.filter(e => e !== pathElement.getAttribute('id'));
                            }
                        } else {
                            const bbox = pathElement.getBBox();
                            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                            rect.setAttribute('x', bbox.x);
                            rect.setAttribute('y', bbox.y);
                            rect.setAttribute('width', bbox.width);
                            rect.setAttribute('height', bbox.height);
                            rect.setAttribute('id', bboxId);
                            rect.classList.add('bounding-box');
                            pathElement.parentNode.insertBefore(rect, pathElement.nextSibling);

                            const listItem = document.createElement('li');
                            listItem.textContent = `Clicked on path element with id: ${pathElement.getAttribute('id') || 'no id'}`;
                            listItem.setAttribute('data-bbox-id', bboxId);
                            clickedElementsList.appendChild(listItem);
                            selectedElements.push(pathElement.getAttribute('id') || 'no id');
                        }
                    });
                });
            }
            MathJax.typeset();
        } catch (error) {
            console.error('Error fetching data:', error);
            contentDiv.textContent = 'Error loading content';
        }
    }

    function resetClickedElements(svgDiv, clickedElementsContainer) {
        svgDiv.querySelectorAll('.bounding-box').forEach(box => box.remove());
        clickedElementsContainer.querySelector('ul').innerHTML = '';
        selectedElements = [];
    }

    function showMessage(message) {
        const messageBox = document.getElementById('message-box');
        messageBox.textContent = message;
        messageBox.style.display = 'block';
        setTimeout(() => {
            messageBox.style.display = 'none';
        }, 3000);
    }

    async function display_steps(pyodide) {
        let files = await pyodide.FS.readdir("Solutions");
        while (files[0] === "." || files[0] === "..") {
            files.splice(0, 1);
        }

        let jsonFiles = [];
        let svgFiles = [];
        files.forEach((file) => {
            if (file.search(".+\\.json") >= 0) {
                jsonFiles.push(file);
            }
            if (file.search(".+\\.svg") >= 0) {
                svgFiles.push(file);
            }
        });

        for (let i = 0; i < jsonFiles.length; i++) {
            if (jsonFiles[i].replace(".json", "") !== svgFiles[i].replace(".svg", "")) {
                pyodide.FS.rmdir("Solutions");
                throw new Error("Files did not match, Solutions cleared please try again");
            }
            display_step(pyodide, "Solutions/" + jsonFiles[i], "Solutions/" + svgFiles[i]);
        }

        MathJax.typeset();
    }

    function createProgressBar(infoText) {
        const container = document.createElement('div');
        container.id = 'progress-container';

        const bar = document.createElement('div');
        bar.id = 'progress-bar';
        bar.textContent = '0%';

        container.appendChild(bar);
        document.body.appendChild(container);

        container.style.display = 'block';
    }

    function updateProgressBar(percentage) {
        const progressBar = document.getElementById('progress-bar');
        progressBar.style.width = percentage + '%';
        progressBar.textContent = percentage + '%';
    }

    function removeProgressBar() {
        const container = document.getElementById('progress-container');
        if (container) {
            container.remove();
        }
    }

    async function load_packages(pyodide, optAddNames) {
        createProgressBar("Loading Pyodide packages, please wait ...");
        updateProgressBar(0);
        let packageAddress = "http://localhost:8000/Packages/";
        let packages = await fetchDirectoryListing(packageAddress, ".whl");

        if (Array.isArray(optAddNames)) {
            for (let i = 0; i < optAddNames.length; i++) {
                packages.push(optAddNames[0]);
            }
        }

        let progress = 0;
        const updateProgress = () => {
            progress += 1;
            updateProgressBar(Math.floor((progress / packages.length) * 100));
        };

        let packagePromises = packages.map(async function (packageName) {
            let pkgArrBuff = await (await fetch("http://localhost:8000/Packages/" + packageName)).arrayBuffer();
            let packageExtension = packageName.slice(packageName.lastIndexOf("."), packageName.length);
            await pyodide.unpackArchive(pkgArrBuff, packageExtension);
            updateProgress();
        });

        await Promise.all(packagePromises);
        console.log("Installed:" + packages);
        removeProgressBar();
    }

    async function main() {
        const infoText = document.createElement('div');
        infoText.id = "infoText";
        infoText.textContent = "";

        document.body.appendChild(infoText);
        infoText.setAttribute('style', 'white-space: pre;');

        infoText.textContent = "Loading Pyodide environment... ";
        let pyodide = await loadPyodide();
        infoText.textContent += "done\r\n";

        let timeLoadPackages = "Load packages";
        console.time(timeLoadPackages);
        infoText.textContent += "Loading necessary python packages, this may take a while... ";
        await load_packages(pyodide, ["sqlite3-1.0.0.zip"]);
        infoText.textContent += "done\r\n";
        console.timeEnd(timeLoadPackages);

        let loadCircuits = "Load Circuits";
        infoText.textContent += "Loading circuits from server... ";
        console.time(loadCircuits);

        let cirArrBuff = await (await fetch("http://localhost:8000/Circuits.zip")).arrayBuffer();
        await pyodide.unpackArchive(cirArrBuff, ".zip");

        circuitFiles = pyodide.FS.readdir("Circuits");
        circuitFiles = circuitFiles.filter((file) => file !== "." && file !== "..");
        console.log("Circuits Files: " + circuitFiles);
        populateCircuitSelector();

        pyodide.FS.writeFile("/home/pyodide/solve.py", await (await fetch("http://localhost:8000/solve.py")).text());
        infoText.textContent += "done\r\n";
        console.timeEnd(loadCircuits);

        document.body.removeChild(infoText);

        document.getElementById('menu-toggle').style.display = 'block';
        document.getElementById('initial-message').style.display = 'block';

        document.getElementById('menu-toggle').addEventListener('click', () => {
            const menuBar = document.getElementById('menu-bar');
            const simplificationDiv = document.getElementById('simplification');
            if (menuBar.style.left === '0px') {
                menuBar.style.left = '-250px';
                simplificationDiv.style.width = '90vw';
            } else {
                menuBar.style.left = '0px';
                simplificationDiv.style.width = 'calc(90vw - 250px)';
            }
        });

        document.getElementById('mode').addEventListener('change', (event) => {
            mode = event.target.value;
            loadSelectedCircuit(pyodide);
        });

        document.getElementById('circuit-selector').addEventListener('change', (event) => {
            currentCircuit = event.target.value;
            loadSelectedCircuit(pyodide);
        });

        document.getElementById('prev-button').addEventListener('click', () => {
            if (currentStep > 0) {
                currentStep--;
                display_step(pyodide, `Solutions/${jsonFiles[currentStep]}`, `Solutions/${svgFiles[currentStep]}`);
            }
        });

        document.getElementById('next-button').addEventListener('click', () => {
            if (currentStep < jsonFiles.length - 1) {
                currentStep++;
                display_step(pyodide, `Solutions/${jsonFiles[currentStep]}`, `Solutions/${svgFiles[currentStep]}`);
            }
        });
    }

    async function loadSelectedCircuit(pyodide) {
        if (mode && currentCircuit) {
            document.getElementById('initial-message').style.display = 'none';
            solveCircuit(currentCircuit, pyodide);
        }
    }

    async function solveCircuit(circuit, pyodide) {
        let timeImporting = "Import Python script";
        console.time(timeImporting);
        let solve = await pyodide.pyimport("solve");
        console.timeEnd(timeImporting);

        let timeSolve = "Solve circuit";
        console.time(timeSolve);

        // Clear old solution files
        try {
            let solutionFiles = await pyodide.FS.readdir("Solutions");
            solutionFiles.forEach(file => {
                if (file !== "." && file !== "..") {
                    pyodide.FS.unlink(`Solutions/${file}`);
                }
            });
        } catch (error) {
            console.warn("Solutions directory not found or already cleared.");
        }

        if (mode === 'user') {
            stepSolve = solve.SolveInUserOrder(circuit, "Circuits/", "Solutions/");
            let initialStep = await stepSolve.createStep0().toJs();
            console.log("Initial Step:", initialStep);
        } else {
            await solve.solve_circuit(circuit);
        }

        console.timeEnd(timeSolve);

        const files = await pyodide.FS.readdir("Solutions");
        jsonFiles = files.filter(file => file.endsWith(".json"));
        svgFiles = files.filter(file => file.endsWith(".svg"));

        currentStep = 0;
        display_step(pyodide, `Solutions/${jsonFiles[currentStep]}`, `Solutions/${svgFiles[currentStep]}`);

        if (mode === 'pre_calculated') {
            document.querySelector('.nav-buttons-container').style.display = 'flex';
        } else {
            document.querySelector('.nav-buttons-container').style.display = 'none';
        }
    }

    main();
</script>
</body>
</html>
